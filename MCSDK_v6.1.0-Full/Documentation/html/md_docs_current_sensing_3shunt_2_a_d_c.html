<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>STM32 Motor Control SDK: Current sampling in three-shunt topology using two A/D converters</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
  tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    }
});
</script>
<script type="text/javascript" async="async" src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="styleSheetFile.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="motor_control.png"/></td>
  <td id="projectalign">
   <div id="projectname">STM32 Motor Control SDK<span id="projectnumber">&#160;MCFW-6.1.0</span>
   </div>
   <div id="projectbrief">Software Development Kit to build applications driving PMSM Motors with STM32</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Current sampling in three-shunt topology using two A/D converters </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Overview</h1>
<p >The figure below shows the three-shunt topology hardware architecture.</p>
<div class="image">
<object type="image/svg+xml" data="current_sensing_3shunt_hwscheme.svg" style="pointer-events: none;"></object>
<div class="caption">
Three-shunt topology hardware architecture</div></div>
    <p >The three currents \(I_1\), \(I_2\), and \(I_3\) flowing through a three-phase system follow the mathematical relation:</p>
<p >$$ I_1+ I_2+ I_3= 0 $$</p>
<p >For this reason, to reconstruct the currents flowing through a generic three-phase load, it is sufficient to sample only two out of the three currents while the third one can be computed by using the above relation.</p>
<p >The flexibility of the STM32 A/D converter makes it possible to synchronously sample the two A/D conversions needed for reconstructing the current flowing through the motor. The ADC can also be used to synchronize the current sampling point with the PWM output using the external triggering capability of the peripheral. Owing to this, current conversions can be performed at any given time during the PWM period. To do this, the control algorithm uses the fourth PWM channel of TIM1 to synchronize the start of the conversions.</p>
<p >The next figure shows the synchronization strategy between the TIM1 PWM output and the ADC. The A/D converter peripheral is configured so that it is triggered by the rising edge of TIM1_CH4.</p>
<div class="image">
<object type="image/svg+xml" data="tim_adc_synchro.svg" style="pointer-events: none;"></object>
<div class="caption">
PWM Timer and ADC synchronization</div></div>
    <p >In this way, supposing that the sampling point must be set before the counter overflow, that is, when the TIM1 counter value matches the OCR4 register value during the upcounting, the A/D conversions for current sampling are started. If the sampling point must be set after the counter overflow, the PWM 4 output has to be inverted by modifying the CC4P bit in the TIM1_CCER register. Thus, when the TIM1 counter matches the OCR4 register value during the downcounting, the A/D samplings are started.</p>
<p >After execution of the FOC algorithm, the value to be loaded into the OCR4 register is calculated to set the sampling point for the next PWM period, and the A/D converter is configured to sample the correct channels.</p>
<h1>Tuning delay parameters and sampling stator currents</h1>
<p >the figure below shows one of the three inverter legs with the related shunt resistor:</p>
<div class="image">
<object type="image/svg+xml" data="high_low_sides_shunt.svg" style="pointer-events: none;"></object>
<div class="caption">
Inverter leg and shunt resistor position</div></div>
    <p >To indirectly measure the phase current I, it is possible to read the voltage V provided that the current flows through the shunt resistor R.</p>
<p >It is possible to demonstrate that, whatever the direction of current I, it always flows through the resistor R if transistor T2 is switched on and T1 is switched off. This implies that, in order to properly reconstruct the current flowing through one of the inverter legs, it is necessary to properly synchronize the conversion start with the generated PWM signals. This also means that current reading cannot be performed on a phase where the duty cycle applied to the low side transistor is either null or very short.</p>
<p >As discussed above, to reconstruct the currents flowing through a generic three-phase load, it is sufficient to simultaneously sample only two out of three currents, the third one being deduced thanks to the \(I_1+ I_2+ I_3= 0\)relation. Thus, depending on the space vector sector, the A/D conversion of voltage V will be performed only on the two phases where the duty cycles applied to the low side switches are the highest.</p>
<p >Looking at the figure below, you can deduct that, in sectors 1 and 6, the voltage on phase A shunt resistor can be discarded; likewise in sectors 2 and 3 for phase B, and in sectors 4 and 5 for phase C.</p>
<div class="image">
<img src="SVPWM_space_voltage_waveforms.png" alt=""/>
</div>
    <p >Moreover, in order to properly synchronize the two stator current reading A/D conversions, it is necessary to distinguish between the different situations that can occur depending on PWM frequency and applied duty cycles.</p>
<p ><b>Note:</b> The explanations below refer to space vector. They can be applied in the same manner to the other sectors.</p>
<h2>Case 1: Duty cycle applied to Phase A low side switch \(&gt; DT+T_N\)</h2>
<p >Where:</p>
<ul>
<li>\(DT\) is dead time.</li>
<li>\(T_N\) is the duration of the noise induced on the shunt resistor voltage of a phase by the commutation of a switch belonging to another phase.</li>
<li>\(T_S\) is the sampling time of the A/D converter (presuming \(T_S &lt; DT + T_N\)). Refer to the relevant microcontrollerreference manual for more information.</li>
</ul>
<p >This case typically occurs when SVPWM with low (&lt;60%) modulation index is generated (see the next figure). The modulation index is the applied phase voltage magnitude expressed as a percentage of the maximum applicable phase voltage (the duty cycle ranges from 0% to 100%).</p>
<div class="image">
<img src="low_side_signals_low_mmi.png" alt=""/>
<div class="caption">
Low-side switch gate signals (low modulation indexes)</div></div>
    <p >The next figure offers a reconstruction of the PWM signals applied to low side switches of phase A and B in these conditions, plus a view of the analog voltages measured on the A/D converter pins for both phase B and C (the time base is lower than the PWM period).</p>
<div class="image">
<img src="shunt_current_reading_case1.png" alt=""/>
<div class="caption">
Case 1</div></div>
    <p ><b>Note:</b></p>
<p >These current feedbacks are constant in previous figure because it is assumed that commutations on phase B and C have occurred out of the visualized time window. In this case, the two stator current sampling conversions can be performed synchronized with the counter overflow, as shown in that figure.</p>
<h2>Case 2: \((DT+T_N+T_S)/2 &lt; ΔDuty_A &lt; DT+T_N\) and \(ΔDuty_{A-B} &lt; DT+T_R+T_S\)</h2>
<p >With the increase in modulation index, \(ΔDuty_A\) can have values smaller than \(DT+T_N\). Sampling synchronized with the counter overflow could be impossible.</p>
<p >In this case, the two currents can still be sampled between the two phase A low side commutations, but only after the counter overflow.</p>
<p >To avoid the acquisition of the noise induced on the phase B current feedback by phase A switch commutations, it is required to wait for the noise to be over ( \(T_N\)). See figure below.</p>
<div class="image">
<img src="shunt_current_reading_case2.png" alt=""/>
<div class="caption">
Case 2</div></div>
    <h2>Case 3: \(ΔDuty_A &lt; (DT+T_N+T_S)/2\) and \(ΔDuty_{A-B} &gt; DT+T_R+T_S\)</h2>
<p >In this case, it is no longer possible to sample the currents during phase A low-side switch-on. Anyway, the two currents can be sampled between phase B low-side switch-on and phase A high-side switch-off. The choice was made to sample the currents \(T_S\) µs before of phase A high-side switch-off. See figure below.</p>
<div class="image">
<img src="shunt_current_reading_case3.png" alt=""/>
<div class="caption">
Case 3</div></div>
    <h2>Case 4: \(ΔDuty_A&lt;(DT+T_N+T_S)/2\) and \(ΔDuty_{A-B} &lt; DT+T_R+T_S\)</h2>
<p >In this case, the duty cycle applied to phase A is so short that no current sampling can be performed between the two low-side commutations.</p>
<p >If the difference in duty cycles between phase B and A is not long enough to allow the A/D conversions to be performed between phase B low-side switch-on and phase A high-side switch-off, it is impossible to sample the currents. See figure below.</p>
<p >To avoid this condition, it is necessary to reduce the maximum modulation index or to decrease the PWM frequency.</p>
<div class="image">
<img src="shunt_current_reading_case4.png" alt=""/>
<div class="caption">
Case 4</div></div>
    <p ><a class="el" href="md_docs_current_sensing_3shunt_1_a_d_c.html">Next: Three-shunt current sensing with 1 ADC</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
&copy; 2022, ST Microelectronics &#160;<a href="http://st.com">
<img class="footer" src="ST_logo_footer.png" alt="ST Microelectronics"/>
</a>
</small></address>
</body>
</html>
