<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>STM32 Motor Control SDK: Current sampling in three-shunt topology using one A/D converter</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
  tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    }
});
</script>
<script type="text/javascript" async="async" src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="styleSheetFile.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="motor_control.png"/></td>
  <td id="projectalign">
   <div id="projectname">STM32 Motor Control SDK<span id="projectnumber">&#160;MCFW-6.1.0</span>
   </div>
   <div id="projectbrief">Software Development Kit to build applications driving PMSM Motors with STM32</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Current sampling in three-shunt topology using one A/D converter </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Overview</h1>
<p >The figure below shows the three-shunt topology hardware architecture.</p>
<div class="image">
<object type="image/svg+xml" data="current_sensing_3shunt_hwscheme.svg" style="pointer-events: none;"></object>
<div class="caption">
Three-shunt topology hardware architecture</div></div>
    <p >The three currents \(I_1\), \(I_2\), and \(I_3\) flowing through a three-phase system follow the mathematical relation:</p>
<p >$$ I_1+ I_2+ I_3= 0 $$</p>
<p >For this reason, in order to rebuild the currents flowing through a generic three-phase load, it is sufficient to sample only two out of the three currents while the third one can be computed by using the above relation.</p>
<p >Unlike the case of <a class="el" href="md_docs_current_sensing_3shunt_2_a_d_c.html">current sampling with two ADCs</a>, in the case of a single ADC it is not possible to synchronously sample the two phase current A/D conversions, needed for reconstructing the current flowing through the motor, but they can be performed only in sequence mode.</p>
<p >The ADC can be used to synchronize the current sampling point with the PWM output using the external triggering capability of the peripheral. Owing to this, current conversion sequence can be performed at any given time during the PWM period.</p>
<p >To do this, the control algorithm uses the fourth PWM channel of TIM1 to synchronize the start of the conversion sequence. This synchronization strategy between the TIM1 PWM output and the ADC is detailed in the next figures.</p>
<div class="image">
<object type="image/svg+xml" data="tim_adc_synchro_rising_ETR.svg" style="pointer-events: none;"></object>
<div class="caption">
PWM and ADC synchronization ADC rising edge external trigger</div></div>
    <div class="image">
<object type="image/svg+xml" data="tim_adc_synchro_falling_ETR.svg" style="pointer-events: none;"></object>
<div class="caption">
PWM and ADC synchronization ADC falling edge external trigger</div></div>
    <p >In this way, supposing that the sampling point must be set before the counter overflow, that is, when the TIMer counter value matches the OCR4 register value during the up counting, the A/D conversion sequence for current sampling are started. If the sampling point must be set after the counter overflow, it’s necessary to set a falling edge ADC external trigger. Thus, when the TIMer counter matches the OCR4 register value during the down counting, the A/D sampling are started.</p>
<p >After execution of the FOC algorithm, the value to be loaded into the OCR4 register is calculated to set the sampling point for the next PWM period, and the A/D converter is configured to sample the correct channels.</p>
<p >The FOC starts after DMA1_Channel1 Transmission is complete (dual sampling). The DMA is used to manage the A/D conversion sequence since the STM32F0x ADC doesn’t support the injected conversion type but only the regular conversion type.</p>
<h1>Tuning delay parameters and sampling stator currents in shunt resistor</h1>
<p >the figure below shows one of the three inverter legs with the related shunt resistor:</p>
<div class="image">
<object type="image/svg+xml" data="high_low_sides_shunt.svg" style="pointer-events: none;"></object>
<div class="caption">
Inverter leg and shunt resistor position</div></div>
    <p >To indirectly measure the phase current I, it is possible to read the voltage V provided that the current flows through the shunt resistor, R.</p>
<p >It is possible to demonstrate that, whatever the direction of current I, it always flows through the resistor R if transistor T2 is switched on and T1 is switched off. This implies that, in order to properly reconstruct the current flowing through one of the inverter legs, it is necessary to properly synchronize the conversion start with the generated PWM signals. This also means that current reading cannot be performed on a phase where the duty cycle applied to the low side transistor is either null or very short.</p>
<p >As discussed above, to rebuild the currents flowing through a generic three-phase load, it is sufficient to sample only two out of three currents, the third one being deduced thanks to the \(I_1+ I_2+ I_3= 0\)relation. It is noted that two current samples are not simultaneous but the start of the second current sampling is delayed from the first current measurement by its global conversion time ( \(T_s + T_c\)); this introduces a conceptual error in the third current computation, because the two current samples are referred to two different time instants and this equation is true if the three current values are referred at the same time instant. Anyway, this error is negligible for a wide range of motors.</p>
<p >Thus, depending on the space vector sector, the A/D conversion of voltage, V, will be performed only on the two phases where the duty cycles applied to the low side switches are the highest. It can be noted that in the sectors 1 and 6, the voltage on phase A shunt resistor can be discarded; likewise in the sectors 2 and 3 for phase B, and in the sectors 4 and 5 for phase C.</p>
<p >Moreover, in order to have a correct A/D conversion of the two stator currents, it is necessary to distinguish between the different situations that can occur depending on PWM frequency and applied duty cycles.</p>
<p >Used symbols:</p>
<ul>
<li>\(DT\) is dead time.</li>
<li>\(T_N\) is the duration of the noise induced on the shunt resistor voltage of a phase by the commutation of a switch belonging to another phase.</li>
<li>\(T_R\) is the rising time of the input signal of the ADC.</li>
<li>\(T_S\) is the sampling time of the A/D.</li>
<li>\(T_C\) is the conversion time of ADC. Refer to the microcontroller reference manual for more detailed information.</li>
</ul>
<p >The following five cases are based on the hypothesis that \(2T_S + T_C &lt; DT + \max(T_N,T_R)\).</p>
<p >It’s possible to individuate a common case for all sectors shown below.</p>
<h2>Common Case</h2>
<p >In this case, Duty cycles applied to Phases A, B, C low side switches are larger than \(DT+ \max(T_N,T_R)\).</p>
<p >Then, to minimize measurement errors due to errors in calibration of the ADC, which introduce inaccuracies in the calculation of the third component by means of the equation \(I_1 + I_2 + I_3 = 0\), always the currents of phases A and B are converted, as shown in the figure below:</p>
<div class="image">
<object type="image/svg+xml" data="shunt_current_reading_1adc_commoncase.svg" style="pointer-events: none;"></object>
<div class="caption">
Low side of phase A, B, C duty cycle &gt; DT + max(TN,TR)</div></div>
    <p >The following explanations refer to space vector sector 1 and can be applied in the same manner to the other sectors.</p>
<p >With the increase of the modulation index, \(∆Duty_A\) , \(∆Duty_B\) , \(∆Duty_C\) can assume values smaller than \(DT+ \max(T_N,T_R)\) and sampling in correspondence of the counter overflow can be impossible.</p>
<p >The following cases depend on the value of the minimum duty cycle of the low side signal between A, B and C phases.</p>
<h2>Case 1</h2>
<p >In this case, the Duty cycle applied to Phase A low side switch is larger than \(DT+ \max(T_N,T_R)\)</p>
<p >This case typically occurs when SVPWM with low a modulation index (&lt;60%) is generated. The modulation index is the applied phase voltage magnitude expressed as a percentage of the maximum applicable phase voltage (the duty cycle ranges from 0% to 100%).</p>
<p >The figure below offers a reconstruction of the PWM signals applied to low side switches of phase A and B in these conditions, in addition of a view of the analog voltages measured on the ADC pins for both phase B and C.</p>
<div class="image">
<object type="image/svg+xml" data="shunt_current_reading_1adc_case1.svg" style="pointer-events: none;"></object>
<div class="caption">
Low side Phase A duty cycle &gt; DT+ max(TN,TR)</div></div>
    <h2>Case 2</h2>
<p >In this case, \(ΔDuty_A &lt; DT + \max(T_N, T_R)\) and \(Duty_{AB} &lt; 2(ΔDuty_A)\)</p>
<p >With the increase in modulation index, \(ΔDuty_A\) can assume values smaller than \(DT+ \max(T_N,T_R)\). Start of conversion sequence synchronized with the counter overflow could be impossible.</p>
<p >In this case, the sequence of two currents can still be sampled between the two phase A low side commutations, but only after the counter overflow.</p>
<p >To avoid the acquisition of the noise induced on the phase B current feedback by phase A switch commutations, it is required to wait for the noise to be over ( \(T_N\)). See figure below.</p>
<div class="image">
<object type="image/svg+xml" data="shunt_current_reading_1adc_case2.svg" style="pointer-events: none;"></object>
<div class="caption">
Two current samplings performed into 2DDutyA time</div></div>
    <h2>Case 3</h2>
<p >In this case, \(ΔDuty_A &lt; DT + \max(T_N, T_R)\) and \(ΔDuty_{AB} &gt;2 (ΔDuty_A)\).</p>
<p >It is then no longer possible to sample the currents during phase A low-side on-state. Anyway, the two currents can be sampled between phase B low-side switch-on and phase A high-side switch-off. The choice was made to sample the currents \((2T_S + T_C)\) μs before of phase A high-side switch-off (see figure below).</p>
<div class="image">
<object type="image/svg+xml" data="shunt_current_reading_1adc_case3.svg" style="pointer-events: none;"></object>
<div class="caption">
Two current samplings performed into DDutyAB time</div></div>
    <h2>Case 4</h2>
<p >In this case, \(ΔDuty_A &lt; DT+ \max(T_N, T_R), ΔDuty_{AB} &gt;2 (ΔDuty_A)\) and \(ΔDuty_{AB} - (DT + T_R) &lt; 2(T_N + T_R)\)</p>
<p >There, the duty cycle applied to phase A is so short that no current sampling can be performed between the two low-side commutations considering that the two sampling are not simultaneous than the time requested to sampling is greater, because between the start of the two samplings there is the time of conversion of the first current.</p>
<p >If the difference in duty cycles between phase B and A is not long enough to allow the A/D conversions to be performed between phase B low-side switch-on and phase A high-side switch-off, it is impossible to sample the currents (See figure below).</p>
<p >To avoid this condition, it is necessary to reduce the maximum modulation index or to decrease the PWM frequency.</p>
<div class="image">
<object type="image/svg+xml" data="shunt_current_reading_1adc_case4.svg" style="pointer-events: none;"></object>
<div class="caption">
Two current samplings cannot performed</div></div>
    <p ><a class="el" href="md_docs_current_sensing_1shunt.html">Next: Single-shunt current sensing</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
&copy; 2022, ST Microelectronics &#160;<a href="http://st.com">
<img class="footer" src="ST_logo_footer.png" alt="ST Microelectronics"/>
</a>
</small></address>
</body>
</html>
