<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>STM32 Motor Control SDK: Current sensing and protection using embedded OpAmps and Comparators</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
  tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    }
});
</script>
<script type="text/javascript" async="async" src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="styleSheetFile.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="motor_control.png"/></td>
  <td id="projectalign">
   <div id="projectname">STM32 Motor Control SDK<span id="projectnumber">&#160;MCFW-6.1.0</span>
   </div>
   <div id="projectbrief">Software Development Kit to build applications driving PMSM Motors with STM32</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Current sensing and protection using embedded OpAmps and Comparators </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Introduction</h1>
<p >The STM32F3 and STM32G4 microcontrollers feature an enhanced set of peripherals including comparators, PGAs, DACs and high-speed ADCs.</p>
<p ><b>Figure 1</b> below shows a current sensing and overcurrent protection scheme that can be implemented using the internal resources of the STM32F302/303. The voltage drop on the shunt resistor, due to the motor phase current, can be either positive or negative, an offset is set by R1 and R2. The signal is linked to a microcontroller input pin that has both functionality of amplifier and comparator non-inverting.</p>
<p ><b>Figure 1.</b> Current sensing and overcurrent protection with embedded OpAmp and Comparators<br  />
 <img src="current_sensing_opamp_comp_intgain.svg" alt="" style="pointer-events: none;" class="inline" title="Current sensing and overcurrent protection with embedded OpAmp and Comparators"/>    </p>
<p >This optimized configuration using an STM32F3 or an STM32G4 reduces the number of external components and microcontroller pins assigned to the MC application.</p>
<h1>Current Sensing</h1>
<p >In order to maximize the resolution of the measurement, the PGA can be used to adapt the level of voltage drop in the shunt resistor ( \(R_{Shunt}\) ), caused by the motor current, up to the maximum range allowed by the analog to digital converter (ADC).</p>
<p >The PGA has a set of fixed internal gains (x2, x4, x8, x16) as presented in <b>Figure 1</b>. An alternative option in PGA mode allows you to route the central point of the resistive network on one of the I/Os connected to the non-inverting input. This feature can be used for instance to add a low- pass filter to PGA, as shown in <b>Figure 2</b>:</p>
<p ><b>Figure 2.</b> Current sensing with embedded OpAmp and external filtering<br  />
 <img src="current_sensing_opamp_comp_extfilter.svg" alt="" style="pointer-events: none;" class="inline" title="Current sensing with embedded OpAmp, internal gain and external filtering"/>    </p>
<p >If a different value of amplification is required, it is possible to define the amplification network (for example, as shown in <b>Figure 3</b>).</p>
<p ><b>Figure 3.</b> Current sensing with embedded OpAmp and external gain<br  />
 <img src="current_sensing_opamp_comp_extgain.svg" alt="" style="pointer-events: none;" class="inline" title="Current sensing with embedded OpAmp and external gain"/>    </p>
<p >Finally, it is also still possible to set up the motor current measurement network to use external operational amplifiers, as with the other STM32 series. In this case the amplified signals are directly fed to the ADC channels.</p>
<p >The MC library can manage all the configurations shown here, thanks to the STM32 Motor Control Workbench. Refer to the STM32 motor control SDK documentation for more information.</p>
<h1>Over-current Protection</h1>
<p >The basic principle of the hardware over-current protection mechanism can be summarized as follows:</p>
<ul>
<li>The phase current of the motor flows in the power transistor of the inverter bridge and passes through the shunt resistor ( \(R_{Shunt}\) ) producing a voltage drop ( \(V^+\) ).</li>
<li>This voltage drop is compared with a threshold ( \(V^−\) ) defining the maximum admissible current.</li>
<li>If the threshold is exceeded, a break signal stops the PWM generation putting the system in a safe state.</li>
</ul>
<p >All of these actions can be performed using the internal resources of the STM32F3/STM32G4 and, in particular, the embedded comparators and the advanced timer break function (<code>BRK2</code>). As shown in <b>Figure 1</b>, <b>Figure 2</b> and <b>Figure 3</b>, the same signal is fed to both not inverting input of embedded comparators and PGA.</p>
<p >The over-current threshold ( \(V^-\)) can be defined in three different ways:</p>
<ul>
<li>Using one of the available internal voltage reference (1.2V, 0.9V, 0.6V and 0.3V);</li>
<li>Providing it externally using the inverting input pin of the comparator; – Programming a DAC channel.</li>
</ul>
<p >Here too, the STM32 MC WB allows for all these configurations when creating a project based on STM32F3 or STM32G4 MCUs.</p>
<p >On the other hand, it is possible to setup the motor over-current protection network to use external components. In this case the over-current protection signal – coming from a comparator for instance – is directly fed to the advanced-timer's <code>BKIN2</code> pin.</p>
<p >In any case, whether using embedded comparators or external components, a digital filter, placed before the <code>BKIN2</code> function, can be enabled and configured in order to reject noises.</p>
<h1>STM32 Resources allocation criteria</h1>
<p >This section deals with the allocations of hardware resources for motor control applications based on STM32F3 or STM32G4 MCUs.</p>
<h2>Single-Shunt topology</h2>
<p >Depending on the chosen configuration – see the <a class="el" href="md_docs_current_sensing_1shunt.html">single-shunt current sensing</a> section – 1 ADC, 1 OPAMP, 1 comparator, and or 1 DAC channel are to be assigned. Here are the conditions governing the allocation of these peripherals:</p>
<ul>
<li>If the <em>Embedded PGA</em> feature is enabled, the selection of the ADC peripheral (and its input pin) is linked to this specific PGA peripheral;</li>
<li>If the <em>Embedded HW OCP</em> and <em>Embedded PGA</em> features are enabled, the ADC and the comparator (as well as their input and '+' pins) to be selected are the ones linked to the chosen PGA peripheral</li>
<li>If the <em>Embedded HW OCP</em> feature is enabled and the <em>Embedded PGA</em> feature is disabled, the selection of the comparator is free.</li>
<li>If the <em>Embedded HW OCP</em> and the <em>Embedded PGA</em> features are both disabled, the selection of the comparator and the ADC is free.</li>
<li>If both PGA and comparator for OC protection are used they will share the same input pins for the motor current measurement signal.</li>
</ul>
<h2>Three-Shunt topology</h2>
<p >Depending on the configuration – see the three-shunt current sensing section – 2 ADCs, 2 OPAMPs, 3 comparators, 1 DAC channel must be assigned. Here are the conditions governing the allocation of these peripherals:</p>
<ul>
<li>If the <em>Embedded PGA</em> feature is enabled, the selection of the ADC peripherals (and its input pins) is linked to these specific PGA peripherals;</li>
<li>If the <em>Embedded HW OCP</em> and the <em>Embedded PGA</em> features are enabled, the ADCs and comparators (and their inputs and <code>+</code> pins) to select are the ones linked to these specific PGA peripherals (and theirs <code>+</code> inputs);</li>
<li>If the <em>Embedded HW OCP</em> feature is enabled and the <em>Embedded PGA</em> feature is disabled, the selection of comparators is free;</li>
<li>If the <em>Embedded HW OCP</em> and <em>Embedded PGA</em> features are both disabled, the selection of comparators and ADCs is free;</li>
<li>The OPAMP1/OPAMP2 pair can be used in a project based on the STM32F3 or on the STM32G4; the OPAMP3/OPAMP4 pair can be used additionally if it is available on the selected MCU;</li>
<li>The ADC1/ADC2 pair can be used in a project based on the STM32F3 or on the STM32G4; the ADC3/ADC4 pair can be used additionally if it is available on the selected MCU.</li>
<li>If both PGA and comparator for OC protection are used they will share the same input pins for the motor current measurement signal.</li>
</ul>
<p ><a class="el" href="md_docs_rotor_speed_pos_feedback.html">Next: Rotor speed &amp; position feedback</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
&copy; 2022, ST Microelectronics &#160;<a href="http://st.com">
<img class="footer" src="ST_logo_footer.png" alt="ST Microelectronics"/>
</a>
</small></address>
</body>
</html>
