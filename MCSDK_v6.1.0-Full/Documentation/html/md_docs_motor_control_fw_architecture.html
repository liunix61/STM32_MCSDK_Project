<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>STM32 Motor Control SDK: Motor Control Firmware architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
  tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    }
});
</script>
<script type="text/javascript" async="async" src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="styleSheetFile.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="motor_control.png"/></td>
  <td id="projectalign">
   <div id="projectname">STM32 Motor Control SDK<span id="projectnumber">&#160;MCFW-6.1.0</span>
   </div>
   <div id="projectbrief">Software Development Kit to build applications driving PMSM Motors with STM32</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Motor Control Firmware architecture </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Anatomy of an application</h1>
<div class="image">
<object type="image/svg+xml" data="mc_application_anatomy.svg" style="pointer-events: none;"></object>
<div class="caption">
Building blocks of a Motor Control Application</div></div>
    <p >the figure above shows a Motor Control application in the way it is structured by ST MC SDK. First, such an application is a software project generated by the Motor Control Workbench thanks to STM32CubeMx. This software project is made of several different parts that interreact:</p>
<ul>
<li>The most important of these parts is the <b>Application</b>. In this context, the Application is developed by the user of ST Motor Control SDK and it focuses on what the final application is meant for, leaving the pure motor control aspects to the code generated by ST MCSDK.</li>
<li>The <b>UI Library</b> provides features from which the user can benefit in the course of the development of the Application, to control and debug it: It handles HW features like push buttons used to start and stop the motor, potentiometers to set the rotor speed reference for instance. More importantly, it also offers debug features like the #Motor Control Protocol Suite.md "Motor Control Protocol Suite" that allows for interfacing the Motor Control application with the ST Motor Pilot tool or the DAC feature... The presence of the UI Library in a Motor Control Application is optional. It would typically no be present in the final application.</li>
<li>The heart of the Firmware of ST MCSDK is the <b>Motor Control Library</b>. This library is made of a set of components, each implementing one of the features provided by the SDK. For most of these features, several components are provided that implement different variants of it. One of the task of the Motor Control Workbench is to pick the right components needed for the user's application.</li>
<li>The Motor Control library components selected for an application are used by the <b>Motor Control Cockpit</b> part. This part actually implements the core algorithms of the motor drive. And it integrates the selected components together. A last major role of the Motor Control Cockpit is to act as the main interface between the motor and the <b>Application</b>.</li>
<li>Both the <b>Application</b> and the <b>UI Library</b> use the Motor Control Application Programming Interface (the <a class="el" href="group___m_c_i_a_p_i.html">MC API</a>) to access the <b>Motor Control Cockpit</b>. MCAPI is the main interface between the <b>Application</b> and the rest of the system. It provides all the functions needed to properly control the motors driven by the application.</li>
<li>However, sometimes, the Application may need to fine tune some internal parameter or get more detailed information than MCAPI can provide. For these cases, it can use the "**MC Low Level API**" which consists in the interface functions provided by all the components of a Motor Control Application. See the <a href="modules.html">Components page</a> for an entry point to the documentation of the <b>MC Low Level API</b>.</li>
<li>The **STM32Cube Drivers **block represents the STM32 peripherals drivers needed in project – Either HAL or LL depending on user's choice. The Motor Control Library itself only uses the LL, the HW peripherals initialization can use either the HAL or the LL. These drivers are copied into the software project generated for the Motor Control Application.</li>
</ul>
<h1>Field Oriented Control Implementation architecture</h1>
<div class="image">
<object type="image/svg+xml" data="mcfw_loops_overview.svg" style="pointer-events: none;"></object>
<div class="caption">
Motor Control FW loops</div></div>
    <p >The firmware of the FOC implementation is organized around three loops:</p>
<ul>
<li>The <a class="el" href="md_docs_motor_control_fw_architecture.html#the-reference-computation-loop">Reference Computation loop</a></li>
<li>The Current Regulation loop</li>
<li>The Safety loop</li>
</ul>
<h2><a class="anchor" id="the-reference-computation-loop"></a>
The Reference Computation loop</h2>
<p >The <b>Reference Computation loop</b> computes the $I_q$ and $I_d$ motor current references that control the behavior of the motor. This is its main task.</p>
<p >To fulfill it, it takes either a Torque reference or a rotor speed reference set by the <b>Application</b> as input. In this latter case, the Reference Computation loop also performs rotor speed regulation. The Reference Computation loop</p>
<p >In addition, the $I_q$ and $I_d$ current references can be influenced by extra, advanced, algorithms such as the <a class="el" href="md_docs_pmsm_maximum_torque_per_ampere_control.html">Maximum Torque Per Ampere</a>, the <a class="el" href="md_docs_flux_weakening_control.html">Flux Weakening</a> or the <a class="el" href="md_docs_feed_forward_current_regulation.html">Feed Forward</a> features.</p>
<p >This loop is implemented in a function named the <a class="el" href="mc__tasks_8c.html#ae66a3f6dc67830ff22319890739f87f9">Medium Frequency Task</a> which is executed on the SysTick interrupt of the STM32 MCU. Usually, the frequency of the Medium Frequency Task is 1 ms. But this is configurable in the Motor Control Workbench down to 500 µs and up to many ms.</p>
<p >500 µs is the default SysTick interrupt frequency of a Motor Control Application generated by teh Motor Control Workbench. And, usually the Medium Frequency Task and thus the Reference Computation Loop runs every other SysTick interrupts.</p>
<p >The Reference Computation Loop also runs a <a class="el" href="md_docs_motor_control_subsystemstatemachine_and_commands_handling.html">state machine</a> that governs the various procedures involved in the duty cycle of the motor: the rev-up (start up) procedure, the shutdown one, the offsets measurement procedure or the management of fault conditions.</p>
<h2>The Current Regulation loop</h2>
<p >The <b>Current Regulation loop</b> is central for an FOC implementation.</p>
<p >Its task is to <a class="el" href="md_docs_current_sampling_intro.html">measure the currents</a> flowing through the phases of the motor, and <a class="el" href="md_docs__p_i_d_regulator_theoretical_background.html">regulate</a> them so that they reach the references set by the <b>Reference Computation loop</b>. To do that, the <b>Current Regulation loop</b> needs to <em>know</em> (and, in the case of sensorless configurations, this means: to <em>estimate</em>) the <a class="el" href="md_docs_rotor_speed_pos_feedback.html">position and the speed</a> of the rotor of the controlled motor.</p>
<p >The <b>Current Regulation loop</b> implements the heart of the <a class="el" href="md_docs_pmsm_fundamental_equations.html">FOC algorithm</a> with the <a href="https://en.wikipedia.org/w/index.php?title=Clarke_transformation">Clark</a> and <a href="https://en.wikipedia.org/w/index.php?title=Park_Transformation">Park</a> transforms, the $I_d$ and $I_d$ current regulation and the <a class="el" href="md_docs_space_vector__p_w_m_implementation.html">Space Vector Pulse Width Modulation</a>. It is triggered in an interrupt context, when the motor phases currents are read (it can be on an ADC interrupt or a DMA interrupt) and does the following:</p>
<ul>
<li>Read of get $I_a$, $I_b$ and $I_c$ phase currents</li>
<li>Compute the position of the rotor</li>
<li>regulate the phase currents which will result in phase voltages to apply</li>
<li>Programs the PWM Timers with duty cycles making the phase voltages computer in the former step</li>
</ul>
<p >Its frequency is fixed and set by the user in the Motor Control Workbench. Typical values range from 5 KHz to 50+ KHz. The Current Regulation loop is executed by the <a class="el" href="group___m_c_tasks.html#ga8c1ddefd0981ca101cfa98acb72aacc4">High Frequency Task</a> function.</p>
<h2>The Safety loop</h2>
<p >The <b>Safety loop</b> is run on the SysTick interrupt, just like the <b>Reference Computation loop</b>. However, it is run on every occurrence of the SysTick while this is not always the case for the latter. Its task is to evaluate a number of fault conditions to determine if they are active or not. Fault conditions include over current, under voltage or over heating conditions. When one of them is detected the operation of the motor is stopped and any eventual control over it is released. See the Faults section of the <a class="el" href="md_docs_motor_control_subsystemstatemachine_and_commands_handling.html">MC State Machine, Commands and Fault management</a> page of the documentation.</p>
<p ><a class="el" href="md_docs_introduction_to_pmsm_foc_drive.html">Next: Introduction to the PMSM FOC drive</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
&copy; 2022, ST Microelectronics &#160;<a href="http://st.com">
<img class="footer" src="ST_logo_footer.png" alt="ST Microelectronics"/>
</a>
</small></address>
</body>
</html>
